<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Demo API Video</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; background: #f4f4f4; }
        input, button, textarea { margin: 8px 0; font-size: 1em; }
        #respuesta { background: #fff; padding: 16px; min-height: 40px; border-radius: 8px; }
    </style>
</head>
<body>
    <h2>Subir vídeo</h2>
    <input type="file" id="videoInput" accept="video/*"><br>
    <button id="uploadBtn">Subir y procesar vídeo</button>
    <div id="uploadResult"></div>

    <h2>Pregunta sobre el vídeo</h2>
    <input type="text" id="videoId" placeholder="ID de vídeo (auto)" style="width: 350px;">
    <br>
    <input type="text" id="questionInput" placeholder="Escribe tu pregunta..." style="width: 350px;">
    <button id="askBtn">Preguntar</button>

    <h3>Respuesta</h3>
    <div id="respuesta"></div>

<script>
let lastVideoId = null;

document.getElementById('uploadBtn').onclick = async function() {
    const fileInput = document.getElementById('videoInput');
    const uploadResult = document.getElementById('uploadResult');
    uploadResult.textContent = 'Procesando...';
    if (!fileInput.files.length) {
        uploadResult.textContent = 'Selecciona un archivo de vídeo.';
        return;
    }
    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    // NO CATCH: simplemente muestra todo el texto que llegue de backend
    const resp = await fetch('http://127.0.0.1:8000/upload', {
        method: 'POST',
        body: formData
    });
    let data;
    try {
        data = await resp.json();
    } catch {
        data = await resp.text();
    }

    // Muestra TODO el cuerpo de la respuesta, sea lo que sea
    let toShow = (typeof data === "object") ? JSON.stringify(data, null, 2) : data;
    uploadResult.textContent = toShow;

    // Si contiene video_id, actualiza el input
    if (typeof data === "object" && data.video_id) {
        lastVideoId = data.video_id;
        document.getElementById('videoId').value = lastVideoId;
    }
};

document.getElementById('askBtn').onclick = async function() {
    const videoId = document.getElementById('videoId').value.trim();
    const pregunta = document.getElementById('questionInput').value.trim();
    const respuestaDiv = document.getElementById('respuesta');
    if (!videoId || !pregunta) {
        respuestaDiv.textContent = 'Introduce el ID del vídeo y una pregunta.';
        return;
    }
    respuestaDiv.textContent = 'Buscando respuesta...';

    // NO CATCH: muestra todo lo que venga, sea JSON, texto, error...
    const resp = await fetch('http://127.0.0.1:8000/ask', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            video_id: videoId,
            question: pregunta,
            top_k: 1
        })
    });
    let data;
    try {
        data = await resp.json();
    } catch {
        data = await resp.text();
    }

    let toShow = (typeof data === "object") ? JSON.stringify(data, null, 2) : data;
    respuestaDiv.textContent = toShow;
};
</script>
</body>
</html>